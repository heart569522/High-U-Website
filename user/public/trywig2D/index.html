<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://libs.zappar.com/zappar-aframe/2.0.0/zappar-aframe.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <a-scene loading-screen="backgroundColor: #344b60">
      <a-entity zappar-permissions-ui id="permissions"></a-entity>
      <a-entity zappar-compatibility-ui id="compatibility"></a-entity>
      <a-assets>
        <img
          id="wigImage"
          crossorigin="anonymous"
          onload="onWigImageLoad()"
          src="./images/wig.png"
        />
      </a-assets>
      <a-camera zappar-camera="user-facing: true;"></a-camera>
      <a-entity visibility-changer>
        <a-entity zappar-face id="face-group">
          <a-entity zappar-head-mask="face: #face-group;"></a-entity>
          <a-image
            id="face-overlay"
            position="0 0.2 1"
            width="2"
            height="2"
            src="#wigImage"
          ></a-image>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent("visibility-changer", {
        init: function () {
          this.el.setAttribute("visible", false);
          this.el.sceneEl.addEventListener("zappar-visible", () =>
            this.el.setAttribute("visible", true)
          );
          this.el.sceneEl.addEventListener("zappar-notvisible", () =>
            this.el.setAttribute("visible", false)
          );
        },
      });

      function onWigImageLoad() {
        const wigImage = document.querySelector("#wigImage");
        const faceGroup = document.querySelector("#face-group");
        const headMask = document.querySelector("a-entity[zappar-head-mask]");

        faceGroup.setAttribute("zappar-face", "");
        headMask.setAttribute("zappar-head-mask", "face: #face-group;");
      }

      window.addEventListener("message", (event) => {
        if (event.data.type === "select") {
          const wigImage = document.querySelector("#wigImage");
          wigImage.src = event.data.image + "?cache-buster=" + Date.now();
        }
        if (event.data.type === "capture") {
          const canvas = document
            .querySelector("a-scene")
            .components.screenshot.getCanvas("perspective", "none");
          const dataUrl = canvas.toDataURL("image/png");
          event.source.postMessage(
            { type: "screenshot", image: dataUrl },
            event.origin
          );
        }
        console.log("Image URL updated:", wigImage.src);
      });
    </script>
  </body>
</html>
